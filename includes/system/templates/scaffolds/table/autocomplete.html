var <%$predictiveServiceController%> = {
	split: function(val) {
		return val.split(/,\s*/);
	},
	extractLast: function(term) {
		return <%$predictiveServiceController%>.split(term).pop();
	}
};

$(document).ready(function () {
	$('.<%$predictiveService%>_autocomplete').each(function () {
		$(this).bind("keydown", function (event) {
			if (event.keyCode === $.ui.keyCode.TAB &&
				$(this).autocomplete("instance").menu.active) {
				event.preventDefault();
			}
		});
		$(this).autocomplete({
			minLength: 0,
			source: function (request, response) {
				var transaction = Math.round(Math.random() * 10000);
				$.getJSON('?service=<%$predictiveService%>', {
					pattern: <%$predictiveServiceController%>.extractLast(request.term),
					limit: 10,
					transaction: transaction
				}, function (json) {
					response(json.status ? json.data.items : []);
				});
			},
			focus: function () {
				// prevent value inserted on focus
				return false;
			},
			select: function (event, ui) {
				var val = $(this).val().split(',');
				val.pop();
				val.push(ui.item.<%$nameField%>);
				val = val.join(', ') + ', ';
				val = val.replace(/, ([ ]+)/g, ', ');
				$(this).val(val);

				return false;
			}
		});
		$(this).autocomplete("instance")._renderItem = function (ul, item) {
			return $('<li>' + item.<%$nameField%> + '</li>').appendTo(ul);
		};
	});
});
